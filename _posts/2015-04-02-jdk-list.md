---
layout: post
title: jdk 中的 List 分析
categories: java基础
tags: 笔记 java
---

### AbstractCollection

此类提供 Collection 接口的骨干实现，以最大限度地减少了实现此接口所需的工作。

要实现一个不可修改的 collection，编程人员只需扩展此类，并提供 iterator 和 size 方法的实现。（iterator 方法返回的迭代器必须实现 hasNext 和 next。）

要实现可修改的 collection，编程人员必须另外重写此类的 add 方法（否则，会抛出 UnsupportedOperationException），iterator 方法返回的迭代器还必须另外实现其 remove 方法。

```java
public abstract class AbstractCollection<E> implements Collection<E> {

    protected AbstractCollection() {
        }

	    public abstract Iterator<E> iterator();

	        public abstract int size();

		    public boolean isEmpty() {
		            return size() == 0;
			        }

				    public boolean contains(Object o) {
				            Iterator<E> it = iterator();
					            if (o==null) {
						                while (it.hasNext())
								                if (it.next()==null)
										                    return true;
												            } else {
													                while (it.hasNext())
															                if (o.equals(it.next()))
																	                    return true;
																			            }
																				            return false;
																					        }


																						    public Object[] toArray() {
																						            // Estimate size of array; be prepared to see more or fewer elements
																							            Object[] r = new Object[size()];
																								            Iterator<E> it = iterator();
																									            for (int i = 0; i < r.length; i++) {
																										                if (! it.hasNext()) // fewer elements than expected
																												                return Arrays.copyOf(r, i);
																														            r[i] = it.next();
																															            }
																																            return it.hasNext() ? finishToArray(r, it) : r;
																																	        }

																																		    public <T> T[] toArray(T[] a) {
																																		            // Estimate size of array; be prepared to see more or fewer elements
																																			            int size = size();
																																				            T[] r = a.length >= size ? a :
																																					                      (T[])java.lang.reflect.Array
																																							                        .newInstance(a.getClass().getComponentType(), size);
																																										        Iterator<E> it = iterator();

																																											        for (int i = 0; i < r.length; i++) {
																																												            if (! it.hasNext()) { // fewer elements than expected
																																													                    if (a == r) {
																																															                        r[i] = null; // null-terminate
																																																		                } else if (a.length < i) {
																																																				                    return Arrays.copyOf(r, i);
																																																						                    } else {
																																																								                        System.arraycopy(r, 0, a, 0, i);
																																																											                    if (a.length > i) {
																																																													                            a[i] = null;
																																																																                        }
																																																																			                }
																																																																					                return a;
																																																																							            }
																																																																								                r[i] = (T)it.next();
																																																																										        }
																																																																											        // more elements than expected
																																																																												        return it.hasNext() ? finishToArray(r, it) : r;
																																																																													    }

																																																																													        private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;

																																																																														    private static <T> T[] finishToArray(T[] r, Iterator<?> it) {
																																																																														            int i = r.length;
																																																																															            while (it.hasNext()) {
																																																																																                int cap = r.length;
																																																																																		            if (i == cap) {
																																																																																			                    int newCap = cap + (cap >> 1) + 1;
																																																																																					                    // overflow-conscious code
																																																																																							                    if (newCap - MAX_ARRAY_SIZE > 0)
																																																																																									                        newCap = hugeCapacity(cap + 1);
																																																																																												                r = Arrays.copyOf(r, newCap);
																																																																																														            }
																																																																																															                r[i++] = (T)it.next();
																																																																																																	        }
																																																																																																		        // trim if overallocated
																																																																																																			        return (i == r.length) ? r : Arrays.copyOf(r, i);
																																																																																																				    }

																																																																																																				        private static int hugeCapacity(int minCapacity) {
																																																																																																					        if (minCapacity < 0) // overflow
																																																																																																						            throw new OutOfMemoryError
																																																																																																							                    ("Required array size too large");
																																																																																																									            return (minCapacity > MAX_ARRAY_SIZE) ?
																																																																																																										                Integer.MAX_VALUE :
																																																																																																												            MAX_ARRAY_SIZE;
																																																																																																													        }

																																																																																																														    public boolean add(E e) {
																																																																																																														            throw new UnsupportedOperationException();
																																																																																																															        }

																																																																																																																    public boolean remove(Object o) {
																																																																																																																            Iterator<E> it = iterator();
																																																																																																																	            if (o==null) {
																																																																																																																		                while (it.hasNext()) {
																																																																																																																				                if (it.next()==null) {
																																																																																																																						                    it.remove();
																																																																																																																								                        return true;
																																																																																																																											                }
																																																																																																																													            }
																																																																																																																														            } else {
																																																																																																																															                while (it.hasNext()) {
																																																																																																																																	                if (o.equals(it.next())) {
																																																																																																																																			                    it.remove();
																																																																																																																																					                        return true;
																																																																																																																																								                }
																																																																																																																																										            }
																																																																																																																																											            }
																																																																																																																																												            return false;
																																																																																																																																													        }

																																																																																																																																														    public boolean containsAll(Collection<?> c) {
																																																																																																																																														            for (Object e : c)
																																																																																																																																															                if (!contains(e))
																																																																																																																																																	                return false;
																																																																																																																																																			        return true;
																																																																																																																																																				    }

																																																																																																																																																				        public boolean addAll(Collection<? extends E> c) {
																																																																																																																																																					        boolean modified = false;
																																																																																																																																																						        for (E e : c)
																																																																																																																																																							            if (add(e))
																																																																																																																																																								                    modified = true;
																																																																																																																																																										            return modified;
																																																																																																																																																											        }

																																																																																																																																																												    public boolean removeAll(Collection<?> c) {
																																																																																																																																																												            boolean modified = false;
																																																																																																																																																													            Iterator<?> it = iterator();
																																																																																																																																																														            while (it.hasNext()) {
																																																																																																																																																															                if (c.contains(it.next())) {
																																																																																																																																																																	                it.remove();
																																																																																																																																																																			                modified = true;
																																																																																																																																																																					            }
																																																																																																																																																																						            }
																																																																																																																																																																							            return modified;
																																																																																																																																																																								        }

																																																																																																																																																																									    public boolean retainAll(Collection<?> c) {
																																																																																																																																																																									            boolean modified = false;
																																																																																																																																																																										            Iterator<E> it = iterator();
																																																																																																																																																																											            while (it.hasNext()) {
																																																																																																																																																																												                if (!c.contains(it.next())) {
																																																																																																																																																																														                it.remove();
																																																																																																																																																																																                modified = true;
																																																																																																																																																																																		            }
																																																																																																																																																																																			            }
																																																																																																																																																																																				            return modified;
																																																																																																																																																																																					        }

																																																																																																																																																																																						    public void clear() {
																																																																																																																																																																																						            Iterator<E> it = iterator();
																																																																																																																																																																																							            while (it.hasNext()) {
																																																																																																																																																																																								                it.next();
																																																																																																																																																																																										            it.remove();
																																																																																																																																																																																											            }
																																																																																																																																																																																												        }

																																																																																																																																																																																													    public String toString() {
																																																																																																																																																																																													            Iterator<E> it = iterator();
																																																																																																																																																																																														            if (! it.hasNext())
																																																																																																																																																																																															                return "[]";

																																																																																																																																																																																																	        StringBuilder sb = new StringBuilder();
																																																																																																																																																																																																		        sb.append('[');
																																																																																																																																																																																																			        for (;;) {
																																																																																																																																																																																																				            E e = it.next();
																																																																																																																																																																																																					                sb.append(e == this ? "(this Collection)" : e);
																																																																																																																																																																																																							            if (! it.hasNext())
																																																																																																																																																																																																								                    return sb.append(']').toString();
																																																																																																																																																																																																										                sb.append(',').append(' ');
																																																																																																																																																																																																												        }
																																																																																																																																																																																																													    }

																																																																																																																																																																																																													    }
																																																																																																																																																																																																													    ```

																																																																																																																																																																																																													    ### AbstractList

																																																																																																																																																																																																													    此类提供 List 接口的骨干实现，以最大限度地减少实现“随机访问”数据存储（如数组）支持的该接口所需的工作。对于连续的访问数据（如链表），应优先使用 AbstractSequentialList，而不是此类。

																																																																																																																																																																																																													    要实现不可修改的列表，编程人员只需扩展此类，并提供 get(int) 和 size() 方法的实现。

																																																																																																																																																																																																													    要实现可修改的列表，编程人员必须另外重写 set(int, E) 方法（否则将抛出 UnsupportedOperationException）。如果列表为可变大小，则编程人员必须另外重写 add(int, E) 和 remove(int) 方法。

																																																																																																																																																																																																													    ```java
																																																																																																																																																																																																													    public abstract class AbstractList<E> extends AbstractCollection<E> implements List<E> {
																																																																																																																																																																																																													    //省略一些代码
																																																																																																																																																																																																													    	public boolean add(E e) {
																																																																																																																																																																																																														        add(size(), e);
																																																																																																																																																																																																															        return true;
																																																																																																																																																																																																																    }
																																																																																																																																																																																																																    	public void add(int index, E element) {
																																																																																																																																																																																																																	        throw new UnsupportedOperationException();
																																																																																																																																																																																																																		    }
																																																																																																																																																																																																																		    }
																																																																																																																																																																																																																		    	public void clear() {
																																																																																																																																																																																																																			        removeRange(0, size());
																																																																																																																																																																																																																				    }
																																																																																																																																																																																																																				        protected void removeRange(int fromIndex, int toIndex) {
																																																																																																																																																																																																																					        ListIterator<E> it = listIterator(fromIndex);
																																																																																																																																																																																																																						        for (int i=0, n=toIndex-fromIndex; i<n; i++) {
																																																																																																																																																																																																																							            it.next();
																																																																																																																																																																																																																								                it.remove();
																																																																																																																																																																																																																										        }
																																																																																																																																																																																																																											    }
																																																																																																																																																																																																																											    ```
																																																																																																																																																																																																																											    ### ArrayList

																																																																																																																																																																																																																											    最常用的容器类，下面详细看下 ArrayList 的内部实现。

																																																																																																																																																																																																																											    ```java
																																																																																																																																																																																																																											    private static final int DEFAULT_CAPACITY = 10;

																																																																																																																																																																																																																											        private static final Object[] EMPTY_ELEMENTDATA = {};

																																																																																																																																																																																																																												    private transient Object[] elementData;

																																																																																																																																																																																																																												        private int size;

																																																																																																																																																																																																																													    public ArrayList(int initialCapacity) {
																																																																																																																																																																																																																													            super();
																																																																																																																																																																																																																														            if (initialCapacity < 0)
																																																																																																																																																																																																																															                throw new IllegalArgumentException("Illegal Capacity: "+
																																																																																																																																																																																																																																	                                               initialCapacity);
																																																																																																																																																																																																																																						               this.elementData = new Object[initialCapacity];
																																																																																																																																																																																																																																							           }

																																																																																																																																																																																																																																								       public ArrayList() {
																																																																																																																																																																																																																																								               super();
																																																																																																																																																																																																																																									               this.elementData = EMPTY_ELEMENTDATA;
																																																																																																																																																																																																																																										           }

																																																																																																																																																																																																																																											       public ArrayList(Collection<? extends E> c) {
																																																																																																																																																																																																																																											               elementData = c.toArray();
																																																																																																																																																																																																																																												               size = elementData.length;
																																																																																																																																																																																																																																													               // c.toArray might (incorrectly) not return Object[] (see 6260652)
																																																																																																																																																																																																																																														               if (elementData.getClass() != Object[].class)
																																																																																																																																																																																																																																															                   elementData = Arrays.copyOf(elementData, size, Object[].class);
																																																																																																																																																																																																																																																	       }
																																																																																																																																																																																																																																																	       ```

																																																																																																																																																																																																																																																	       上面是 ArrayList 的构造方法和里面的一些属性。

																																																																																																																																																																																																																																																	       一般创建 ArrayList 的时候都使用空的构造方法。下面看下 add 等方法。

																																																																																																																																																																																																																																																	       ```java
																																																																																																																																																																																																																																																	       public boolean add(E e) {
																																																																																																																																																																																																																																																	               ensureCapacityInternal(size + 1);  // Increments modCount!!
																																																																																																																																																																																																																																																		               elementData[size++] = e;
																																																																																																																																																																																																																																																			               return true;
																																																																																																																																																																																																																																																				           }

																																																																																																																																																																																																																																																					       private void ensureCapacityInternal(int minCapacity) {
																																																																																																																																																																																																																																																					               if (elementData == EMPTY_ELEMENTDATA) {
																																																																																																																																																																																																																																																						                   minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity);
																																																																																																																																																																																																																																																								           }

																																																																																																																																																																																																																																																									           ensureExplicitCapacity(minCapacity);
																																																																																																																																																																																																																																																										       }

																																																																																																																																																																																																																																																										           private void ensureExplicitCapacity(int minCapacity) {
																																																																																																																																																																																																																																																											           modCount++;

																																																																																																																																																																																																																																																												           // overflow-conscious code
																																																																																																																																																																																																																																																													           if (minCapacity - elementData.length > 0)
																																																																																																																																																																																																																																																														               grow(minCapacity);
																																																																																																																																																																																																																																																															           }

																																																																																																																																																																																																																																																																       private void grow(int minCapacity) {
																																																																																																																																																																																																																																																																               // overflow-conscious code
																																																																																																																																																																																																																																																																	               int oldCapacity = elementData.length;
																																																																																																																																																																																																																																																																		               int newCapacity = oldCapacity + (oldCapacity >> 1);
																																																																																																																																																																																																																																																																			               if (newCapacity - minCapacity < 0)
																																																																																																																																																																																																																																																																				                   newCapacity = minCapacity;
																																																																																																																																																																																																																																																																						           if (newCapacity - MAX_ARRAY_SIZE > 0)
																																																																																																																																																																																																																																																																							               newCapacity = hugeCapacity(minCapacity);
																																																																																																																																																																																																																																																																								               // minCapacity is usually close to size, so this is a win:
																																																																																																																																																																																																																																																																									               elementData = Arrays.copyOf(elementData, newCapacity);
																																																																																																																																																																																																																																																																										           }
																																																																																																																																																																																																																																																																											   ```

																																																																																																																																																																																																																																																																											   当第一次添加元素的时候，在 ensureCapacityInternal 这个方法中的时候 minCapacity 会被设置成 10。然后在 ensureExplicitCapacity 中需要对当前的数组进行扩容。

																																																																																																																																																																																																																																																																											   再看其他的 add 方法：

																																																																																																																																																																																																																																																																											   ```java
																																																																																																																																																																																																																																																																											   public void add(int index, E element) {
																																																																																																																																																																																																																																																																											           rangeCheckForAdd(index);

																																																																																																																																																																																																																																																																												           ensureCapacityInternal(size + 1);  // Increments modCount!!
																																																																																																																																																																																																																																																																													           System.arraycopy(elementData, index, elementData, index + 1,
																																																																																																																																																																																																																																																																														                            size - index);
																																																																																																																																																																																																																																																																																	            elementData[index] = element;
																																																																																																																																																																																																																																																																																		            size++;
																																																																																																																																																																																																																																																																																			        }
																																																																																																																																																																																																																																																																																				```

																																																																																																																																																																																																																																																																																				从 ArrayList 的内部实现方式来看，ArrayList 对 add 添加元素的执行效率是最高，并且随机读取数据的效率也是最高的，但是在指定位置插入和删除元素的效率基本上会涉及到大范围的数组复制。所以平时在使用的时候，真对不同的情况选择适当的 List。

																																																																																																																																																																																																																																																																																				--- EOF ---

